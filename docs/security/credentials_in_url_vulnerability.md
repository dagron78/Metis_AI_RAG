# Credentials in URL Query Parameters Security Vulnerability

## Overview

A security vulnerability was identified where user credentials (username and password) were being passed in URL query parameters (e.g., `/login?username=user&password=pass`). This is a significant security risk for the following reasons:

1. **Log Exposure**: Credentials in URLs are logged by web servers, proxies, and potentially other systems
2. **Browser History**: They remain in browser history and can be seen by anyone with access to the device
3. **Referrer Headers**: They may be visible in referrer headers when navigating to other sites
4. **Caching**: They can be cached in various places (browser cache, proxy cache, etc.)

## Root Cause Analysis

This was not an intentional feature of the application. The authentication code uses secure methods:
- The login form in login.html submits credentials via POST request
- The auth.py API endpoints use OAuth2PasswordRequestForm for secure credential handling
- The middleware/auth.py only redirects to the login page with a redirect parameter

The issue was likely coming from:
- A bookmark with credentials in the URL
- A script or tool constructing these insecure URLs
- A browser extension or other tool modifying URLs
- Users manually typing credentials in the URL

## Implemented Solution

### 1. Server-side Detection and Redirection

The login route now detects credentials in URL parameters and:
- Logs the security event (without logging the actual credentials)
- Redirects to a clean login URL
- Preserves any legitimate redirect parameters
- Adds a security warning flag to the URL

```python
# Check for credentials in URL params (security vulnerability)
params = request.query_params
has_credentials = "username" in params or "password" in params

if has_credentials:
    # Log security event (without logging the actual credentials)
    client_host = request.client.host if request.client else "unknown"
    user_agent = request.headers.get("user-agent", "unknown")
    logger.warning(
        f"Security alert: Credentials detected in URL parameters. "
        f"IP: {client_host}, "
        f"User-Agent: {user_agent}"
    )
    
    # Get redirect param if it exists
    redirect_param = params.get("redirect", "")
    # Create clean URL (without credentials)
    clean_url = "/login" + (f"?redirect={redirect_param}" if redirect_param else "")
    
    # Redirect to clean URL with warning flag
    return RedirectResponse(
        url=clean_url + ("&" if redirect_param else "?") + "security_warning=credentials_in_url",
        status_code=status.HTTP_303_SEE_OTHER
    )
```

### 2. Enhanced Security Headers

Added additional security headers to prevent leaking sensitive information:

```python
# Add Referrer-Policy to prevent leaking URL parameters to external sites
response.headers["Referrer-Policy"] = "same-origin"

# Add HSTS header for HTTPS enforcement
response.headers["Strict-Transport-Security"] = "max-age=31536000; includeSubDomains"

# Add Cache-Control for sensitive pages
if path in ["/login", "/register", "/forgot-password", "/reset-password"]:
    response.headers["Cache-Control"] = "no-store, no-cache, must-revalidate, max-age=0"
    response.headers["Pragma"] = "no-cache"
    response.headers["Expires"] = "0"

# Enhanced Content Security Policy
response.headers["Content-Security-Policy"] = (
    "default-src 'self'; "
    "script-src 'self'; "
    "style-src 'self'; "
    "img-src 'self' data:; "
    "connect-src 'self';"
    "form-action 'self';"
)
```

### 3. Client-side Detection and Warning

Added client-side JavaScript to detect and clean credentials from URLs:

```javascript
// Check for credentials in URL and clean them up
function checkAndCleanCredentialsInUrl() {
    const urlParams = new URLSearchParams(window.location.search);
    const hasUsername = urlParams.has('username');
    const hasPassword = urlParams.has('password');
    
    if (hasUsername || hasPassword) {
        // Show warning
        const errorMessage = document.getElementById('error-message');
        errorMessage.textContent = 'WARNING: Credentials should never be included in URLs as this is a security risk. The URL has been cleaned.';
        errorMessage.style.display = 'block';
        
        // Save redirect parameter if present
        const redirect = urlParams.get('redirect');
        
        // Clean the URL (keep only redirect parameter if it exists)
        const cleanUrl = redirect 
            ? `/login?redirect=${encodeURIComponent(redirect)}` 
            : '/login';
        
        // Replace current URL without reloading
        window.history.replaceState({}, document.title, cleanUrl);
    }
}
```

### 4. User Education

Added a security notice on the login page:

```html
<div class="security-notice" style="margin-bottom: 15px; padding: 8px; background-color: #fff8e6; border-left: 4px solid #ffe066; font-size: 0.9em;">
    <strong>Security Notice:</strong> Never include your credentials in URLs or bookmarks. Always use this secure login form.
</div>
```

### 5. Comprehensive Logging

Added a middleware to log all suspicious requests with sensitive parameters in URLs:

```python
async def log_suspicious_requests(request: Request, call_next):
    """
    Middleware to log suspicious requests that might pose security risks
    """
    path = request.url.path
    query_params = request.query_params
    
    # Check for sensitive parameters in URLs
    sensitive_params = ['username', 'password', 'token', 'key', 'secret', 'api_key', 'auth']
    found_sensitive = [param for param in sensitive_params if param in query_params]
    
    if found_sensitive:
        # Collect request metadata for security analysis
        client_ip = request.client.host if request.client else "unknown"
        user_agent = request.headers.get("user-agent", "unknown")
        referrer = request.headers.get("referer", "none")
        
        # Log security event (without logging the actual sensitive values)
        logger.warning(
            f"Security alert: Sensitive parameters ({', '.join(found_sensitive)}) "
            f"detected in URL for path: {path}. "
            f"IP: {client_ip}, "
            f"User-Agent: {user_agent}, "
            f"Referrer: {referrer}"
        )
    
    # Continue with the request
    response = await call_next(request)
    return response
```

## Additional Recommendations

1. **Rate Limiting**: Implement rate limiting for login attempts to prevent brute force attacks
2. **Automated Alerts**: Set up an automated alert system for suspicious login patterns
3. **URL Parameter Review**: Review existing URL parameter handling across the application
4. **Log Auditing**: Regularly audit logs for security anomalies
5. **Security Training**: Provide security training for developers on secure authentication practices

## Testing

To verify the fix:
1. Try accessing `/login?username=test&password=test123`
2. You should be redirected to `/login?security_warning=credentials_in_url`
3. A warning message should appear on the login page
4. Check the logs for a security alert entry

## References

- [OWASP - Password in URL](https://owasp.org/www-community/vulnerabilities/Information_exposure_through_query_strings_in_url)
- [CWE-598: Information Exposure Through Query Strings in URL](https://cwe.mitre.org/data/definitions/598.html)
- [NIST Guidelines for Password-Based Authentication](https://pages.nist.gov/800-63-3/sp800-63b.html)