{% extends "base.html" %}

{% block title %}Documents - Metis RAG{% endblock %}

{% block head %}
<style>
    .upload-container {
        max-width: 800px;
        margin: 50px auto;
        padding: 30px;
        background-color: #fff;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .upload-title {
        font-size: 24px;
        margin-bottom: 20px;
        text-align: center;
    }
    
    .upload-form {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }
    
    .form-group {
        margin-bottom: 20px;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
    }
    
    .form-group input,
    .form-group select {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }
    
    .upload-btn {
        padding: 15px 30px;
        background-color: #ff0000;
        color: white;
        border: 4px dashed #ffff00;
        cursor: pointer;
        font-size: 18px;
        font-weight: bold;
        margin: 20px auto;
        display: block;
        border-radius: 8px;
    }
    
    .status-message {
        padding: 15px;
        margin-top: 20px;
        border-radius: 4px;
        display: none;
    }
    
    .status-success {
        background-color: #4CAF50;
        color: white;
    }
    
    .status-error {
        background-color: #F44336;
        color: white;
    }
    
    .status-info {
        background-color: #2196F3;
        color: white;
    }
    
    .progress-container {
        width: 100%;
        height: 20px;
        background-color: #f1f1f1;
        border-radius: 10px;
        margin-top: 10px;
        overflow: hidden;
    }
    
    .progress-bar {
        height: 100%;
        background-color: #4CAF50;
        width: 0%;
        transition: width 0.3s;
    }
</style>
{% endblock %}

{% block content %}
<div class="upload-container">
    <h2 class="upload-title">Document Upload</h2>

    <div style="text-align: center; margin-bottom: 30px;">
        <p>Use this form to upload documents to the RAG system</p>
    </div>
    
    <form id="simple-upload-form" enctype="multipart/form-data">
        <div class="form-group">
            <label for="file-input">Select Document:</label>
            <input type="file" id="file-input" accept=".pdf,.txt,.csv,.md,.docx,.doc,.rtf,.html,.json,.xml" required>
        </div>
        
        <div class="form-group">
            <label for="tags-input">Tags (comma separated):</label>
            <input type="text" id="tags-input" placeholder="e.g. important, reference, work">
        </div>
        
        <div class="form-group">
            <label for="folder-input">Folder:</label>
            <select id="folder-input">
                <option value="/">Root</option>
            </select>
        </div>
        
        <button type="button" id="upload-button" class="upload-btn">UPLOAD DOCUMENT</button>
        
        <div id="progress-container" class="progress-container" style="display:none;">
            <div id="progress-bar" class="progress-bar"></div>
        </div>
        
        <div id="status-message" class="status-message"></div>
    </form>
</div>

<div style="margin-top: 30px; text-align: center; padding: 20px; border: 1px solid #ddd; border-radius: 8px; background-color: #f9f9f9; max-width: 800px; margin-left: auto; margin-right: auto;">
    <h3>Emergency Database Actions</h3>
    <button id="emergency-clear-btn" style="margin-top: 10px; padding: 10px 20px; background-color: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">EMERGENCY CLEAR ALL DOCUMENTS</button>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log("Simple document upload script loaded");
    
    const uploadButton = document.getElementById('upload-button');
    const statusMessage = document.getElementById('status-message');
    const progressContainer = document.getElementById('progress-container');
    const progressBar = document.getElementById('progress-bar');
    
    // Global token that will be set by createTestUser
    let authToken = '';
    
    // Helper function to show status messages
    function showStatus(message, type) {
        if (!statusMessage) return;
        
        statusMessage.textContent = message;
        statusMessage.style.display = 'block';
        
        // Remove all classes
        statusMessage.classList.remove('status-success', 'status-error', 'status-info');
        
        // Add appropriate class
        statusMessage.classList.add(`status-${type}`);
    }
    
    // No need to create a test user anymore since we've modified the middleware
    showStatus('Ready to upload documents', 'success');
    
    // Emergency clear button
    const emergencyBtn = document.getElementById('emergency-clear-btn');
    if (emergencyBtn) {
        emergencyBtn.addEventListener('click', function() {
            if (!confirm('EMERGENCY: This will permanently delete ALL documents from the system. This action cannot be undone. Are you sure you want to continue?')) {
                return;
            }
            
            if (!confirm('FINAL WARNING: All documents will be permanently deleted. Proceed?')) {
                return;
            }
            
            // Call the API endpoint - no auth header needed now
            fetch('/api/documents/actions/clear-all', {
                method: 'DELETE'
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to clear documents');
                }
                return response.json();
            })
            .then(data => {
                showStatus(`EMERGENCY CLEAR SUCCESSFUL: Cleared ${data.document_count} documents from the system.`, 'success');
            })
            .catch(error => {
                console.error('Error clearing documents:', error);
                showStatus('EMERGENCY CLEAR FAILED: ' + error.message, 'error');
            });
        });
    }
    
    uploadButton.addEventListener('click', function() {
        const fileInput = document.getElementById('file-input');
        const tagsInput = document.getElementById('tags-input');
        const folderInput = document.getElementById('folder-input');
        
        if (!fileInput.files || fileInput.files.length === 0) {
            showStatus('Please select a file to upload', 'error');
            return;
        }
        
        const file = fileInput.files[0];
        console.log(`Selected file: ${file.name} (${file.size} bytes)`);
        
        // Show progress container
        progressContainer.style.display = 'block';
        progressBar.style.width = '10%';
        
        // Create FormData
        const formData = new FormData();
        formData.append('file', file);
        
        // Add tags if provided
        if (tagsInput.value.trim()) {
            formData.append('tags', tagsInput.value.trim());
        }
        
        // Add folder if provided
        if (folderInput.value) {
            formData.append('folder', folderInput.value);
        }
        
        // Show uploading status
        showStatus('Uploading document...', 'info');
        
        // Use special dev-upload endpoint that doesn't require authentication
        fetch('/api/documents/dev-upload', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            console.log("Upload response status:", response.status);
            progressBar.style.width = '70%';
            return response.json();
        })
        .then(data => {
            console.log("Upload response data:", data);
            progressBar.style.width = '100%';
            
            if (data.success) {
                showStatus(`Document "${file.name}" uploaded successfully in dev mode!`, 'success');
                fileInput.value = '';
                tagsInput.value = '';
                
                // Show file path
                if (data.file_path) {
                    console.log(`File saved to: ${data.file_path}`);
                }
            } else {
                showStatus(`Error uploading document: ${data.message || 'Unknown error'}`, 'error');
            }
            
            // Hide progress after delay
            setTimeout(() => {
                progressContainer.style.display = 'none';
                progressBar.style.width = '0%';
            }, 3000);
        })
        .catch(error => {
            console.error("Upload error:", error);
            showStatus(`Error uploading document: ${error.message}`, 'error');
            progressContainer.style.display = 'none';
        });
    });
    
    // This function is now defined earlier in the code to avoid reference errors
    
    // Process a document after upload
    function processDocument(documentId) {
        console.log(`Processing document: ${documentId}`);
        showStatus('Processing document...', 'info');
        
        // Default chunking options
        const request = {
            document_ids: [documentId],
            force_reprocess: false,
            chunking_strategy: 'recursive'
        };
        
        // Process the document - no auth header needed now
        fetch('/api/documents/process', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(request)
        })
        .then(response => response.json())
        .then(data => {
            console.log("Processing response:", data);
            if (data.success) {
                showStatus(`Document uploaded and processing started successfully!`, 'success');
            } else {
                showStatus(`Document uploaded but processing failed: ${data.message || 'Unknown error'}`, 'info');
            }
        })
        .catch(error => {
            console.error("Processing error:", error);
            showStatus(`Document uploaded but processing request failed: ${error.message}`, 'info');
        });
    }
});
</script>
{% endblock %}