{% extends "base.html" %}

{% block title %}Basic Documents - Metis RAG{% endblock %}

{% block head %}
<style>
    /* Fix for scrolling issue */
    .main-content {
        overflow-y: auto !important;
    }
    
    /* Status badges */
    .status-badge {
        display: inline-block;
        font-size: 0.7em;
        padding: 2px 6px;
        border-radius: 10px;
        margin-left: 8px;
        color: white;
        vertical-align: middle;
    }
    
    .status-pending {
        background-color: #f0ad4e; /* Orange */
    }
    
    .status-processing {
        background-color: #5bc0de; /* Blue */
    }
    
    .status-completed {
        background-color: #5cb85c; /* Green */
    }
    
    .status-failed {
        background-color: #d9534f; /* Red */
    }
    .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }
    
    .navigation-links {
        margin-bottom: 20px;
    }
    
    .nav-link {
        display: inline-flex;
        align-items: center;
        padding: 8px 16px;
        background-color: var(--primary-color);
        color: white;
        text-decoration: none;
        border-radius: 4px;
        font-weight: 500;
        transition: background-color 0.2s;
    }
    
    .home-link {
        background-color: var(--secondary-color, #6c757d);
        margin-right: 10px;
    }
    
    .home-link:hover {
        background-color: var(--secondary-hover-color, #5a6268);
    }
    
    .nav-link:hover {
        background-color: var(--primary-hover-color, #0056b3);
    }
    
    .nav-link i {
        margin-right: 8px;
    }

    .section {
        margin-bottom: 30px;
        background-color: var(--card-bg);
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .section-title {
        margin-top: 0;
        margin-bottom: 20px;
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 10px;
    }

    /* Upload Section */
    .upload-form {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    .file-input-container {
        border: 2px dashed var(--border-color);
        border-radius: 5px;
        padding: 20px;
        text-align: center;
        cursor: pointer;
    }

    .file-input-container:hover {
        border-color: var(--primary-color);
    }

    .file-input {
        display: none;
    }

    /* Document List */
    .document-list {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
    }

    .document-card {
        border: 1px solid var(--border-color);
        border-radius: 5px;
        padding: 15px;
        background-color: var(--card-bg);
    }

    .document-title {
        font-size: 1.2em;
        margin-top: 0;
        margin-bottom: 10px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .document-meta {
        font-size: 0.9em;
        color: var(--muted-color);
        margin-bottom: 15px;
    }

    .document-actions {
        display: flex;
        justify-content: flex-start;
        gap: 10px;
        margin-top: 15px;
    }

    .document-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
        margin-bottom: 10px;
    }

    .document-tag {
        background-color: var(--primary-color);
        color: white;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.8em;
    }

    /* Modal */
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1000;
    }

    .modal-content {
        position: relative;
        background-color: var(--card-bg);
        margin: 10% auto;
        padding: 20px;
        border-radius: 5px;
        width: 80%;
        max-width: 600px;
    }

    .modal-close {
        position: absolute;
        top: 10px;
        right: 10px;
        font-size: 1.5em;
        cursor: pointer;
    }

    .modal-title {
        margin-top: 0;
        margin-bottom: 20px;
        font-size: 1.5em;
    }

    .form-group {
        margin-bottom: 15px;
    }

    .form-group label {
        display: block;
        margin-bottom: 5px;
    }

    .form-group input,
    .form-group textarea {
        width: 100%;
        padding: 8px;
        border: 1px solid var(--border-color);
        border-radius: 4px;
    }

    .button-group {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        margin-top: 20px;
    }

    .btn {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }

    .btn-primary {
        background-color: var(--primary-color);
        color: white;
    }

    .btn-danger {
        background-color: #dc3545;
        color: white;
    }

    .btn-secondary {
        background-color: var(--border-color);
        color: var(--text-color);
    }
    
    /* Statistics Section */
    .statistics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
    }
    
    .stat-card {
        background-color: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 5px;
        padding: 15px;
        text-align: center;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }
    
    .stat-title {
        font-size: 0.9em;
        color: var(--muted-color);
        margin-bottom: 10px;
    }
    
    .stat-value {
        font-size: 1.8em;
        font-weight: bold;
        color: var(--primary-color);
    }
    
    .btn:disabled {
        opacity: 0.6;
    }
    
    .error-message {
        background-color: #ffebee;
        color: #c62828;
        padding: 10px;
        border-radius: 4px;
        margin-top: 15px;
        border-left: 4px solid #c62828;
        cursor: not-allowed;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <h1>Basic Document Management</h1>
    <div class="navigation-links">
        <a href="/" class="nav-link home-link"><i class="fas fa-home"></i> Back to Main Page</a>
        <a href="/documents" class="nav-link"><i class="fas fa-file-alt"></i> Go to Documents Page</a>
    </div>
    
    <div class="section">
        <h2 class="section-title">Vector Store Statistics</h2>
        <div id="statistics-container">
            <div class="statistics-grid">
                <div class="stat-card">
                    <div class="stat-title">Documents in Database</div>
                    <div class="stat-value" id="db-document-count">Loading...</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">Chunks in Database</div>
                    <div class="stat-value" id="db-chunk-count">Loading...</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">Documents in Vector Store</div>
                    <div class="stat-value" id="vector-document-count">Loading...</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">Chunks in Vector Store</div>
                    <div class="stat-value" id="vector-chunk-count">Loading...</div>
                </div>
            </div>
            <div class="button-group" style="justify-content: flex-start; margin-top: 15px;">
                <button id="refresh-stats" class="btn btn-secondary">
                    <i class="fas fa-sync-alt"></i> Refresh Statistics
                </button>
            </div>
        </div>
    </div>
    
    <div class="section">
        <h2 class="section-title">Upload Document</h2>
        <form id="upload-form" class="upload-form">
            <div class="file-input-container" id="file-drop-area">
                <p>Drag and drop files here or click to select</p>
                <p class="file-types">Supported formats: PDF, TXT, DOCX, MD, CSV</p>
                <input type="file" id="file-input" class="file-input" multiple>
            </div>
            
            <div class="form-group">
                <label for="tags-input">Tags (comma separated)</label>
                <input type="text" id="tags-input" placeholder="e.g. important, reference, work">
            </div>
            
            <div class="form-group">
                <label for="folder-input">Folder</label>
                <input type="text" id="folder-input" placeholder="e.g. /projects/research" value="/">
            </div>
            
            <div class="button-group">
                <button type="submit" class="btn btn-primary">Upload</button>
            </div>
        </form>
    </div>
    
    <div class="section">
        <h2 class="section-title">Documents</h2>
        <div id="document-list" class="document-list">
            <!-- Documents will be loaded here -->
            <div class="loading">Loading documents...</div>
        </div>
    </div>
</div>

<!-- Edit Document Modal -->
<div id="edit-modal" class="modal">
    <div class="modal-content">
        <span class="modal-close">&times;</span>
        <h2 class="modal-title">Edit Document</h2>
        
        <form id="edit-form">
            <input type="hidden" id="edit-document-id">
            
            <div class="form-group">
                <label for="edit-tags">Tags (comma separated)</label>
                <input type="text" id="edit-tags">
            </div>
            
            <div class="form-group">
                <label for="edit-folder">Folder</label>
                <input type="text" id="edit-folder">
            </div>
            
            <div class="button-group">
                <button type="button" class="btn btn-secondary" id="cancel-edit">Cancel</button>
                <button type="submit" class="btn btn-primary">Save Changes</button>
            </div>
        </form>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="delete-modal" class="modal">
    <div class="modal-content">
        <span class="modal-close">&times;</span>
        <h2 class="modal-title">Confirm Delete</h2>
        
        <p>Are you sure you want to delete this document? This action cannot be undone.</p>
        
        <div class="button-group">
            <button type="button" class="btn btn-secondary" id="cancel-delete">Cancel</button>
            <button type="button" class="btn btn-danger" id="confirm-delete">Delete</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // DOM Elements
        const fileDropArea = document.getElementById('file-drop-area');
        const fileInput = document.getElementById('file-input');
        const uploadForm = document.getElementById('upload-form');
        const documentList = document.getElementById('document-list');
        const editModal = document.getElementById('edit-modal');
        const deleteModal = document.getElementById('delete-modal');
        const editForm = document.getElementById('edit-form');
        const cancelEdit = document.getElementById('cancel-edit');
        const cancelDelete = document.getElementById('cancel-delete');
        const confirmDelete = document.getElementById('confirm-delete');
        const modalCloseButtons = document.querySelectorAll('.modal-close');
        
        // Variables
        let currentDocumentId = null;
        
        // File Drop Area
        fileDropArea.addEventListener('click', () => {
            fileInput.click();
        });
        
        fileDropArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            fileDropArea.style.borderColor = 'var(--primary-color)';
            fileDropArea.style.backgroundColor = 'rgba(0, 123, 255, 0.1)';
        });
        
        fileDropArea.addEventListener('dragleave', () => {
            fileDropArea.style.borderColor = 'var(--border-color)';
            fileDropArea.style.backgroundColor = '';
        });
        
        fileDropArea.addEventListener('drop', (e) => {
            e.preventDefault();
            fileDropArea.style.borderColor = 'var(--border-color)';
            fileDropArea.style.backgroundColor = '';
            
            if (e.dataTransfer.files.length > 0) {
                fileInput.files = e.dataTransfer.files;
                const fileNames = Array.from(e.dataTransfer.files).map(file => file.name).join(', ');
                fileDropArea.querySelector('p').textContent = `Selected files: ${fileNames}`;
            }
        });
        
        fileInput.addEventListener('change', () => {
            if (fileInput.files.length > 0) {
                const fileNames = Array.from(fileInput.files).map(file => file.name).join(', ');
                fileDropArea.querySelector('p').textContent = `Selected files: ${fileNames}`;
            }
        });
        
        // Upload Form
        uploadForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const files = fileInput.files;
            if (files.length === 0) {
                alert('Please select at least one file to upload');
                return;
            }
            
            const tags = document.getElementById('tags-input').value;
            const folder = document.getElementById('folder-input').value;
            
            for (const file of files) {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('tags', tags);
                formData.append('folder', folder);
                
                try {
                    const response = await fetch('/api/basic-documents/upload', {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.detail || 'Failed to upload document');
                    }
                    
                    const result = await response.json();
                    console.log('Upload successful:', result);
                } catch (error) {
                    console.error('Upload failed:', error);
                    alert(`Failed to upload ${file.name}: ${error.message}`);
                }
            }
            
            // Reset form and reload documents
            uploadForm.reset();
            fileDropArea.querySelector('p').textContent = 'Drag and drop files here or click to select';
            loadDocuments();
        });
        
        // Function to refresh document status
        async function refreshDocumentStatus() {
            try {
                const response = await fetch('/api/basic-documents/list');
                if (!response.ok) {
                    throw new Error('Failed to refresh document status');
                }
                
                const documents = await response.json();
                
                // Update status badges for each document
                documents.forEach(doc => {
                    const statusBadges = document.querySelectorAll(`.document-card[data-id="${doc.id}"] .status-badge`);
                    if (statusBadges.length > 0) {
                        statusBadges.forEach(badge => {
                            badge.className = `status-badge status-${doc.processing_status || 'pending'}`;
                            badge.textContent = doc.processing_status ? doc.processing_status.charAt(0).toUpperCase() + doc.processing_status.slice(1) : 'Pending';
                        });
                    }
                });
            } catch (error) {
                console.error('Failed to refresh document status:', error);
            }
        }
        
        // Periodically refresh document status (every 5 seconds)
        setInterval(refreshDocumentStatus, 5000);
        
        // Load Documents
        async function loadDocuments() {
            try {
                documentList.innerHTML = '<div class="loading">Loading documents...</div>';
                
                const response = await fetch('/api/basic-documents/list');
                if (!response.ok) {
                    throw new Error('Failed to load documents');
                }
                
                const documents = await response.json();
                
                if (documents.length === 0) {
                    documentList.innerHTML = '<div class="no-documents">No documents found. Upload some documents to get started!</div>';
                    return;
                }
                
                documentList.innerHTML = '';
                
                documents.forEach(doc => {
                    const card = document.createElement('div');
                    card.className = 'document-card';
                    card.setAttribute('data-id', doc.id);
                    
                    const title = document.createElement('h3');
                    title.className = 'document-title';
                    title.textContent = doc.filename;
                    
                    // Add processing status indicator
                    const statusBadge = document.createElement('span');
                    statusBadge.className = `status-badge status-${doc.processing_status || 'pending'}`;
                    statusBadge.textContent = doc.processing_status ? doc.processing_status.charAt(0).toUpperCase() + doc.processing_status.slice(1) : 'Pending';
                    title.appendChild(statusBadge);
                    
                    const meta = document.createElement('div');
                    meta.className = 'document-meta';
                    meta.textContent = `Uploaded: ${new Date(doc.created_at).toLocaleString()}`;
                    
                    const tags = document.createElement('div');
                    tags.className = 'document-tags';
                    
                    if (doc.tags && doc.tags.length > 0) {
                        doc.tags.forEach(tag => {
                            const tagEl = document.createElement('span');
                            tagEl.className = 'document-tag';
                            tagEl.textContent = tag;
                            tags.appendChild(tagEl);
                        });
                    }
                    
                    const folder = document.createElement('div');
                    folder.className = 'document-meta';
                    folder.textContent = `Folder: ${doc.folder || '/'}`;
                    
                    const actions = document.createElement('div');
                    actions.className = 'document-actions';
                    
                    const editBtn = document.createElement('button');
                    editBtn.className = 'btn btn-secondary';
                    editBtn.textContent = 'Edit';
                    editBtn.addEventListener('click', () => openEditModal(doc));
                    
                    const processBtn = document.createElement('button');
                    processBtn.className = 'btn btn-primary';
                    processBtn.textContent = 'Process';
                    processBtn.addEventListener('click', () => processDocument(doc.id));
                    
                    // Disable process button if document is already being processed
                    if (doc.processing_status === 'processing') {
                        processBtn.disabled = true;
                        processBtn.textContent = 'Processing...';
                    } else if (doc.processing_status === 'completed') {
                        processBtn.textContent = 'Reprocess';
                    }
                    
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'btn btn-danger';
                    deleteBtn.textContent = 'Delete';
                    deleteBtn.addEventListener('click', () => openDeleteModal(doc.id));
                    
                    actions.appendChild(editBtn);
                    actions.appendChild(processBtn);
                    actions.appendChild(deleteBtn);
                    
                    card.appendChild(title);
                    card.appendChild(meta);
                    card.appendChild(tags);
                    card.appendChild(folder);
                    card.appendChild(actions);
                    
                    documentList.appendChild(card);
                });
            } catch (error) {
                console.error('Failed to load documents:', error);
                documentList.innerHTML = `<div class="error">Error loading documents: ${error.message}</div>`;
            }
        }
        
        // Edit Document
        function openEditModal(document) {
            currentDocumentId = document.id;
            document.getElementById('edit-document-id').value = document.id;
            document.getElementById('edit-tags').value = document.tags ? document.tags.join(', ') : '';
            document.getElementById('edit-folder').value = document.folder || '/';
            
            editModal.style.display = 'block';
        }
        
        editForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const tags = document.getElementById('edit-tags').value;
            const folder = document.getElementById('edit-folder').value;
            
            try {
                // Update tags
                const tagsResponse = await fetch(`/api/basic-documents/${currentDocumentId}/tags`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        tags: tags.split(',').map(tag => tag.trim()).filter(tag => tag)
                    })
                });
                
                if (!tagsResponse.ok) {
                    throw new Error('Failed to update tags');
                }
                
                // Update folder
                const folderResponse = await fetch(`/api/basic-documents/${currentDocumentId}/folder`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        folder: folder
                    })
                });
                
                if (!folderResponse.ok) {
                    throw new Error('Failed to update folder');
                }
                
                // Close modal and reload documents
                editModal.style.display = 'none';
                loadDocuments();
            } catch (error) {
                console.error('Failed to update document:', error);
                alert(`Failed to update document: ${error.message}`);
            }
        });
        
        // Process Document
        async function processDocument(documentId) {
            try {
                // Find the process button for this document
                const card = document.querySelector(`.document-card[data-id="${documentId}"]`);
                const processBtn = Array.from(card.querySelectorAll('button')).find(btn => btn.textContent === 'Process' || btn.textContent === 'Reprocess');
                
                // Update button state
                const originalText = processBtn.textContent;
                processBtn.textContent = 'Processing...';
                processBtn.disabled = true;
                
                // Update status badge
                const statusBadge = card.querySelector('.status-badge');
                statusBadge.className = 'status-badge status-processing';
                statusBadge.textContent = 'Processing';
                
                // Send request to process document
                const response = await fetch(`/api/basic-documents/${documentId}/process`, {
                    method: 'POST'
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to process document');
                }
                
                // Success - the status will be updated by the periodic refresh
                console.log(`Document ${documentId} is being processed`);
                
                // Start refreshing status more frequently during processing
                const refreshInterval = setInterval(() => {
                    refreshDocumentStatus();
                    
                    // Check if processing is complete
                    const currentBadge = card.querySelector('.status-badge');
                    if (currentBadge.textContent !== 'Processing') {
                        clearInterval(refreshInterval);
                        processBtn.disabled = false;
                        processBtn.textContent = currentBadge.textContent === 'Completed' ? 'Reprocess' : 'Process';
                    }
                }, 2000);
                
                // Stop the frequent refreshing after 2 minutes (failsafe)
                setTimeout(() => {
                    clearInterval(refreshInterval);
                    if (processBtn.disabled) {
                        processBtn.disabled = false;
                        processBtn.textContent = originalText;
                    }
                }, 120000);
                
            } catch (error) {
                console.error('Failed to process document:', error);
                alert(`Failed to process document: ${error.message}`);
                
                // Reset button state
                const card = document.querySelector(`.document-card[data-id="${documentId}"]`);
                const processBtn = Array.from(card.querySelectorAll('button')).find(btn => btn.textContent === 'Processing...');
                if (processBtn) {
                    processBtn.textContent = 'Process';
                    processBtn.disabled = false;
                }
            }
        }
        
        // Delete Document
        function openDeleteModal(documentId) {
            currentDocumentId = documentId;
            deleteModal.style.display = 'block';
        }
        
        confirmDelete.addEventListener('click', async () => {
            try {
                // Show loading state
                const confirmBtn = document.getElementById('confirm-delete');
                const originalText = confirmBtn.textContent;
                confirmBtn.textContent = 'Deleting...';
                confirmBtn.disabled = true;
                
                const response = await fetch(`/api/basic-documents/${currentDocumentId}`, {
                    method: 'DELETE'
                });
                
                // Parse the response even if it's not OK to get error details
                const result = await response.json().catch(() => ({}));
                
                if (!response.ok) {
                    throw new Error(result.detail || 'Failed to delete document');
                }
                
                // Close modal and reload documents
                deleteModal.style.display = 'none';
                loadDocuments();
            } catch (error) {
                console.error('Failed to delete document:', error);
                alert(`Failed to delete document: ${error.message}`);
                
                // Reset button state
                const confirmBtn = document.getElementById('confirm-delete');
                confirmBtn.textContent = 'Delete';
                confirmBtn.disabled = false;
            }
        });
        
        // Modal Close Buttons
        modalCloseButtons.forEach(button => {
            button.addEventListener('click', () => {
                editModal.style.display = 'none';
                deleteModal.style.display = 'none';
            });
        });
        
        cancelEdit.addEventListener('click', () => {
            editModal.style.display = 'none';
        });
        
        cancelDelete.addEventListener('click', () => {
            deleteModal.style.display = 'none';
        });
        
        // Close modals when clicking outside
        window.addEventListener('click', (e) => {
            if (e.target === editModal) {
                editModal.style.display = 'none';
            }
            if (e.target === deleteModal) {
                deleteModal.style.display = 'none';
            }
        });
        
        // Load documents on page load
        loadDocuments();
        
        // Load statistics on page load
        setTimeout(loadStatistics, 1000); // Delay loading statistics to ensure page is fully loaded
        
        // Function to load statistics
        async function loadStatistics() {
            try {
                console.log('Loading statistics...');
                const response = await fetch('/api/vector-stats', {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                });
                
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Error response:', errorText);
                    throw new Error(`Failed to load statistics: ${response.status} ${response.statusText}`);
                }
                
                const statistics = await response.json();
                console.log('Statistics loaded:', statistics);
                
                // Update statistics in the UI
                document.getElementById('db-document-count').textContent = statistics.db_document_count || 0;
                document.getElementById('db-chunk-count').textContent = statistics.db_chunk_count || 0;
                document.getElementById('vector-document-count').textContent = statistics.total_documents || 0;
                document.getElementById('vector-chunk-count').textContent = statistics.total_chunks || 0;
            } catch (error) {
                console.error('Failed to load statistics:', error);
                document.getElementById('db-document-count').textContent = 'Error';
                document.getElementById('db-chunk-count').textContent = 'Error';
                document.getElementById('vector-document-count').textContent = 'Error';
                document.getElementById('vector-chunk-count').textContent = 'Error';
                
                // Show error in UI
                const statisticsContainer = document.getElementById('statistics-container');
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error-message';
                errorDiv.textContent = `Error: ${error.message}`;
                statisticsContainer.appendChild(errorDiv);
            }
        }
        
        // Refresh statistics button
        document.getElementById('refresh-stats').addEventListener('click', () => {
            // Update UI to show loading state
            document.getElementById('db-document-count').textContent = 'Loading...';
            document.getElementById('db-chunk-count').textContent = 'Loading...';
            document.getElementById('vector-document-count').textContent = 'Loading...';
            document.getElementById('vector-chunk-count').textContent = 'Loading...';
            
            // Load statistics
            loadStatistics();
        });
    });
</script>
{% endblock %}